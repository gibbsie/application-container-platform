



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Kube cert manager - Application Container Platform</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#kube-cert-managaer-cloudflare-ssl" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="Application Container Platform" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Application Container Platform
            </span>
            <span class="md-header-nav__topic">
              Kube cert manager
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="Application Container Platform" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Application Container Platform
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../services.html" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../releases-notes/index.html" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="index.html" title="How To's" class="md-nav__link">
      How To's
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../developer-docs/index.html" title="Developer Getting Started Guide" class="md-nav__link">
      Developer Getting Started Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../newuser.html" title="New User Guide" class="md-nav__link">
      New User Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../rbac.html" title="RBAC Guide" class="md-nav__link">
      RBAC Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../external-addresses.html" title="ACP External IPs" class="md-nav__link">
      ACP External IPs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../service-lifecycle.html" title="Service Lifecycle" class="md-nav__link">
      Service Lifecycle
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#kube-cert-managaer-cloudflare-ssl" title="Kube-Cert-Managaer &amp; Cloudflare SSL" class="md-nav__link">
    Kube-Cert-Managaer &amp; Cloudflare SSL
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Kube cert manager</h1>
                
                <h2 id="kube-cert-managaer-cloudflare-ssl">Kube-Cert-Managaer &amp; Cloudflare SSL<a class="headerlink" href="#kube-cert-managaer-cloudflare-ssl" title="Permanent link">#</a></h2>
<p>Services:
- <a href="https://github.com/PalmStoneGames/kube-cert-manager">kube-cert-manager</a> is used to retrieve Letencrypt certificates.
- <a href="https://github.com/cloudflare/cfssl">cfssl</a> is an internal certificate service used to provide internal tls between pods / services.</p>
<h4><strong>Domains and Challenge types</strong></h4>
<p>At present two Let's Encrypt challenge types are supported for certificates which is controlled via the <code>stable.k8s.psg.io/kcm.provider</code> annotation on the Ingress resource; note if no annotation is present the default is <code>stable.k8s.psg.io/kcm.provider: route53</code>.</p>
<ul>
<li>route53: the domain must be hosted within the ACP route53 account, namely to allow kube-cert-manager to add the service record. If you are unsure if this is the case please check with the ACP team. DNS is optional for external sites but a requirement for sites seated behind the VPN.</li>
<li>http: indicates a callback url for authentication. The domain can either be controlled externally via yourself or via the ACP team. Either way the dns record must be a CNAME to the external ingress hostname <em>(please check with the ACP team if you dont know)</em>. Obviously this challenge type can only be used on an external site. Note any IP white-listing on the ingress can still be used.</li>
</ul>
<h4><strong>As a developer I want to grab a certificate from Letsencrypt</strong></h4>
<p>Below is an example of an ingress resource for a HTTPS host reachable over the internet. Note, your ingress resource using IP whitelisting is irrelivant here in regard to Letsencrypt i.e you can still protect the site with and ACL.</p>
<ul>
<li>The host <code>my-app.my-project.homeoffice.gov.uk</code> has a CNAME record to <code>ingress-external.prod.acp.homeoffice.gov.uk</code> (or relevant <code>ingress-external</code> address for the cluster you are using)</li>
</ul>
<pre><code class="YAML">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    # indicate the ingress SHOULD speak TLS between itself and pods - in version 0.18.0 of ingress this was deprecated.
    ingress.kubernetes.io/secure-backends: &quot;true&quot;
    # This replaces the old annotation secure-backends
    ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;
    kubernetes.io/ingress.class: nginx-external
    # ensure kube-cert-manager uses a http01 challenge
    stable.k8s.psg.io/kcm.provider: http
  labels:
    # this is a toggle to indicate kube-cert-manager should handle this resource
    stable.k8s.psg.io/kcm.class: default
  name: my-app
spec:
  rules:
  - host: my-app.my-project.homeoffice.gov.uk
    http:
      paths:
      - backend:
          serviceName: my-app
          servicePort: 443
        path: /
  tls:
  - hosts:
    - my-app.my-project.homeoffice.gov.uk
    secretName: my-app-external-tls
</code></pre>

<h4><strong>As a developer I want a certificate from a site behind the vpn</strong></h4>
<p>Using Letsencrypt</p>
<p>Below is an example of an ingress resource for a HTTPS host reachable via VPN or services on the private network.</p>
<ul>
<li>The host <code>my-app.my-project.homeoffice.gov.uk</code> has a CNAME record to <code>ingress-internal.prod.acp.homeoffice.gov.uk</code> (or relevant <code>ingress-internal</code> address for the cluster you are using)</li>
<li>The host <code>my-app.my-project.homeoffice.gov.uk</code> is managed via Route53 within the same account that the cluster is running within (done by ACP team)</li>
<li>The host <code>my-app.my-project.homeoffice.gov.uk</code> (or TLD) is listed as a <a href="https://github.com/UKHomeOffice/policy-admission/blob/master/pkg/authorize/kubecertmanager/doc.go#L33">Hosted Domain</a> within the custom policy admission controller (done by ACP team)</li>
</ul>
<pre><code class="YAML">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    # indicate the ingress SHOULD speak TLS between itself and pods - in version 0.18.0 of ingress this was deprecated.
    ingress.kubernetes.io/secure-backends: &quot;true&quot;
    # This replaces the old annotation secure-backends
    ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;
    kubernetes.io/ingress.class: nginx-internal
  labels:
    stable.k8s.psg.io/kcm.class: default
  name: my-app
spec:
  rules:
  - host: my-app.my-project.homeoffice.gov.uk
    http:
      paths:
      - backend:
          serviceName: my-app
          servicePort: 443
        path: /
  tls:
  - hosts:
    - my-app.my-project.homeoffice.gov.uk
    secretName: my-app-internal-tls
</code></pre>

<h4><strong>Using LetsEncrypt with Ingress</strong></h4>
<p>Assuming you are not bringing your own certificates, LetsEncrypt can be used to acquire certificates for both internal <em>(behind vpn NOT cluster TLS certs)</em> and external certificates. Simply place the annotation <code>stable.k8s.psg.io/kcm.class: default</code> into the ingress resource; A full list of the supported features can be found <a href="https://github.com/PalmStoneGames/kube-cert-manager/blob/master/docs/ingress.md">here</a>. Note at present we ONLY allow you to request certificates via the ingress resource, not by the third party resource.</p>
<h4><strong>As a developer I want a certificate for my pod / service</strong></h4>
<h5><strong>The CA bundle</strong></h5>
<p>By default, in all namespaces a CA bundle has been added which can been mounted into the /etc/ssl/certs of the container and which contains the root CA used to verify authenticity of the certificates. An example of using it is given below.</p>
<p>Below is example of how to acquire a certificate from CloudflareSSL.</p>
<pre><code class="YAML">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: example
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        name: example
    spec:
      volumes:
      - name: bundle
        configMap:
          name: bundle
      - name: certs
        emptyDir: {}
      initContainers:
      - name: certs
        # PLEASE do not use latest, but check for the latest tag in the releases page of https://github.com/UKHomeOffice/cfssl-sidekick
        image: quay.io/ukhomeofficedigital/cfssl-sidekick:latest
        securityContext:
          runAsNonRoot: true
        args:
        - --certs=/certs
        - --domain=myservice.${KUBE_NAMESPACE}.svc.cluster.local
        - --domain=another_domain_name
        - --expiry=8760h
        env:
        - name: KUBE_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        # an emptyDir which the sidekicks writes the certificates
        - name: certs
          mountPath: /certs
        # The platform CA Bundle hold the root ca used to verify the certificate chain
        - name: bundle
          mountPath: /etc/ssl/certs
          readOnly: true
      containers:
      - name: your_application
        image: quay.io/ukhomeofficedigital/some_image
        ...
        ports:
        - name: https
          port: 443
          targetPort: 443
        volumeMounts:
        # You can configure your application to pick up the certificates from here (tls.pem and tls-key.pem)
        - name: certs
          mountPath: /certs
          readOnly: true
</code></pre>

<p>To break down what is happening. Firstly we are adding two volumes <code>bundle</code> and <code>certs</code>.</p>
<ul>
<li>the <code>bundle</code> volume is mapped to a configmap which as indicated above is published by us into every namespace and contains the a certificate bundle. This is mounted into the default PKI directory of the container <code>/etc/ssl/certs</code> and permits the container to trust the service.</li>
<li>the <code>certs</code> is a emptyDir which is a <a href="https://en.wikipedia.org/wiki/Tmpfs">tmpfs</a> volume and used to share the cecertificates between the sidekick and your application.</li>
</ul>
<p>We then inject into the <a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">initContainers</a> the sidekick service. The sidekick is responsible for</p>
<ul>
<li>locally generating a private key <em>(the private key itself never crosses the wire)</em></li>
<li>generating a CSR for the certificate and requesting a signing from cloudflare service.</li>
<li>once the certificate has been signed its placed into <code>--certs=dir</code> directory which in this case is the emptyDir shared across the containers.</li>
</ul>
<p>Note, if you wish to trust certificates generated by this service simply mounted the bundle into the certificates dorectory.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>