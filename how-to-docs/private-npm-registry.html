



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Private npm registry - Application Container Platform</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#using-artifactory-as-a-private-npm-registry" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="Application Container Platform" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Application Container Platform
            </span>
            <span class="md-header-nav__topic">
              Private npm registry
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="Application Container Platform" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Application Container Platform
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../services.html" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../releases-notes/index.html" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="index.html" title="How To's" class="md-nav__link">
      How To's
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../developer-docs/index.html" title="Developer Getting Started Guide" class="md-nav__link">
      Developer Getting Started Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../newuser.html" title="New User Guide" class="md-nav__link">
      New User Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../rbac.html" title="RBAC Guide" class="md-nav__link">
      RBAC Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../external-addresses.html" title="ACP External IPs" class="md-nav__link">
      ACP External IPs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../service-lifecycle.html" title="Service Lifecycle" class="md-nav__link">
      Service Lifecycle
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-artifactory-as-a-private-npm-registry" title="Using artifactory as a private npm registry" class="md-nav__link">
    Using artifactory as a private npm registry
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Private npm registry</h1>
                
                <h2 id="using-artifactory-as-a-private-npm-registry">Using artifactory as a private npm registry<a class="headerlink" href="#using-artifactory-as-a-private-npm-registry" title="Permanent link">#</a></h2>
<p>A step-by-step guide.</p>
<p>This guide makes the following assumptions:</p>
<ul>
<li>you have drone ci set up for your project already</li>
<li>you are using <code>node@8</code> and <code>npm@5</code> or later</li>
<li>you are connected to ACP VPN</li>
</ul>
<h4>Setting up a local environment</h4>
<h5>Get your username and API key from artifactory</h5>
<p>Visit https://artifactory.digital.homeoffice.gov.uk/artifactory/webapp/#/profile, make a note of your username, and if you don't already have an API key then generate one.</p>
<h5>base64 encode your API key</h5>
<pre><code>echo -n &lt;api key&gt; | base64
</code></pre>

<h5>Set local environment variables</h5>
<p>Copy your encoded password, and set the following environment variables in your bash profile:</p>
<pre><code>export NPM_AUTH_USERNAME=&lt;username&gt;
export NPM_AUTH_TOKEN=&lt;base64 encoded api key&gt;
</code></pre>

<p>You might then need to <code>source</code> your profile to load these environment variables.</p>
<h4>Setting up CI in drone</h4>
<h5>Request a bot token for artifactory</h5>
<p>You can do this through the <a href="https://hub.acp.homeoffice.gov.uk/help/support/requests/new/artifactory-bot">ACP Hub</a>. You'll need to provide a username for the bot when you create it.</p>
<p>One of the ACP team will create a token and send it to you as an encrypted gpg file via email.</p>
<p>Decrypt the token</p>
<pre><code>gpg --decrypt ./path/to/file.gpg
</code></pre>

<h5>Add the token to drone as a secret</h5>
<p>First, base64 encode the token:</p>
<pre><code>echo -n &quot;&lt;token&gt;&quot; | base64
</code></pre>

<p>Then add this token to drone as a secret:</p>
<pre><code>drone secret add UKHomeOffice/&lt;repo&gt; NPM_AUTH_TOKEN &lt;base64-encoded-token&gt; --event pull_request
</code></pre>

<p><strong>Note: You will need to make sure the event types are lowercase. If an event is capitalised, it won't match the standard events inside of drone</strong></p>
<p>Note: you will need to make the secret available to pull request builds to be able to run npm commands in pull request steps</p>
<h5>Expose secret to build steps</h5>
<p>You will need to configure any steps which use npm to be able to access the secret. Do this by adding a <code>secret</code> property to those steps as follows:</p>
<pre><code class="yaml">  my_step:
    image: node:8
    secrets:
      - npm_auth_token
    commands:
      - npm install
      - npm test
</code></pre>

<h5>Expose username to build steps</h5>
<p>In addition, you will need to add the username (as you provided when creating your token) as an environment variable. The easiest way to do this is as a "matrix" variable, which makes the username available to all steps without needing to configure them all individually.</p>
<pre><code class="yaml">matrix:
  NPM_AUTH_USERNAME:
    - &lt;username&gt;
</code></pre>

<h4>Publishing modules to artifactory</h4>
<p>It is generally recommended to use a common namespace to publish your modules under. npm allows namespace specific configuration, which makes it easier to ensure that modules are always installed from artifactory, and will not accidentally try to install a public module with the same name.</p>
<h5>Setting publish registry</h5>
<p>Add <code>publishConfig</code> to package.json. This ensures that the module can only ever be published to the private registry, and misconfiguration won't accidentally make it public</p>
<pre><code class="json">&quot;publishConfig&quot;: {
  &quot;registry&quot;: &quot;https://artifactory.digital.homeoffice.gov.uk/artifactory/api/npm/npm-virtual/&quot;
}
</code></pre>

<h5>Add auth settings</h5>
<p>In your project's <code>.npmrc</code> file (create one if it does not already exist) add the following lines:</p>
<pre><code>//artifactory.digital.homeoffice.gov.uk/artifactory/api/npm/npm-virtual/:username=${NPM_AUTH_USERNAME}
//artifactory.digital.homeoffice.gov.uk/artifactory/api/npm/npm-virtual/:_password=${NPM_AUTH_TOKEN}
//artifactory.digital.homeoffice.gov.uk/artifactory/api/npm/npm-virtual/:email=test@example.com
</code></pre>

<p>The email address can be anything, it just needs to be set.</p>
<h5>Add publish step to drone</h5>
<p>Add the following step to your <code>.drone.yml</code> file to publish a new version whenever you release a tag.</p>
<pre><code class="yaml">  publish:
    image: node:8
    secrets:
      - npm_auth_token
    commands:
      - npm publish
    when:
      event: tag
</code></pre>

<p>Now, when you push new tags to github then drone should publish them to the artifactory npm registry automatically.</p>
<h4>Using modules from artifactory as dependencies</h4>
<h5>Configure your project to use artifactory</h5>
<p>In the project which is has private modules as dependencies, add the following line to <code>.npmrc</code> in the root of the project (create this file if it does not exist).</p>
<pre><code>@&lt;namespace&gt;:registry = https://artifactory.digital.homeoffice.gov.uk/artifactory/api/npm/npm-virtual/
</code></pre>

<p>This will ensure that any module under that namespace will only ever install from artifactory, and never from the public registry</p>
<p>If using multiple namespaces then add a line for each namespace.</p>
<p>If the modules you are installing are not namespaced in artifactory, you can add the line with the namespace removed (i.e. <code>registry = ...</code>) but this will have a negative impact on install speed.</p>
<p>You should then add the following line to your project's <code>.npmrc</code> if they are not already there:</p>
<pre><code>//artifactory.digital.homeoffice.gov.uk/artifactory/api/npm/npm-virtual/:username=${NPM_AUTH_USERNAME}
//artifactory.digital.homeoffice.gov.uk/artifactory/api/npm/npm-virtual/:_password=${NPM_AUTH_TOKEN}
</code></pre>

<p>You should now be able to install modules from artifactory into your local development environment.</p>
<h4>Installing dependencies in docker</h4>
<p>If you build a docker image as part of your CI pipeline, you will need to copy the <code>.npmrc</code> file into your image before installing there.</p>
<p>Example <code>Dockerfile</code>:</p>
<pre><code>FROM quay.io/ukhomeofficedigital/nodejs-base:v8

ARG NPM_AUTH_USERNAME
ARG NPM_AUTH_TOKEN

COPY .npmrc /app/.npmrc
COPY package.json /app/package.json
COPY package-lock.json /app/package-lock.json
RUN npm install --production --no-optional
COPY . /app

USER nodejs

CMD node index.js
</code></pre>

<p>When building the image, you will then need to pass the username and token variables into docker with the <code>--build-arg</code> flag.</p>
<pre><code>docker build --build-arg NPM_AUTH_USERNAME=$${NPM_AUTH_USERNAME} --build-arg NPM_AUTH_TOKEN=$${NPM_AUTH_TOKEN} .
</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>